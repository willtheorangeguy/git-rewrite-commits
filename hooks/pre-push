#!/bin/sh
#
# Git pre-push hook to review and fix commit messages before pushing
#
# Installation:
#   1. Copy this file to .git/hooks/pre-push
#   2. Make it executable: chmod +x .git/hooks/pre-push
#
# This hook will:
# - Show you which commits need improvement before pushing
# - Ask for confirmation before making changes
# - Only process unpushed commits

# Check if OPENAI_API_KEY is set
if [ -z "$OPENAI_API_KEY" ]; then
    echo "âš ï¸  OPENAI_API_KEY not set, skipping commit message check"
    exit 0
fi

# Get the remote and branch
remote="$1"
url="$2"

# Count unpushed commits
unpushed=$(git rev-list @{u}..HEAD --count 2>/dev/null || echo "0")

if [ "$unpushed" -eq "0" ]; then
    exit 0
fi

echo "ğŸ” Checking $unpushed unpushed commit(s) for quality..."
echo ""

# First, do a dry run to show what would change
npx git-rewrite-commits --max-commits "$unpushed" --dry-run

# Ask for confirmation
echo ""
echo "Would you like to apply these improvements before pushing? (y/n)"
read -r answer < /dev/tty

if [ "$answer" = "y" ] || [ "$answer" = "yes" ]; then
    echo "ğŸ“ Improving commit messages..."
    npx git-rewrite-commits --max-commits "$unpushed" --skip-backup
    echo "âœ… Commit messages improved! Continuing with push..."
else
    echo "â­ï¸  Skipping improvements, continuing with original messages..."
fi

exit 0
